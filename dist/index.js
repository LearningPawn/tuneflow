"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var Cn="1.13.2",hn=typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global||Function("return this")()||{},Bt=Array.prototype,ce=Object.prototype,fn=typeof Symbol<"u"?Symbol.prototype:null,Wi=Bt.push,It=Bt.slice,ft=ce.toString,ji=ce.hasOwnProperty,yn=typeof ArrayBuffer<"u",ts=typeof DataView<"u",es=Array.isArray,gn=Object.keys,pn=Object.create,dn=yn&&ArrayBuffer.isView,ns=isNaN,rs=isFinite,Sn=!{toString:null}.propertyIsEnumerable("toString"),mn=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],is=Math.pow(2,53)-1;function E(e,t){return t=t==null?e.length-1:+t,function(){for(var n=Math.max(arguments.length-t,0),r=Array(n),i=0;i<n;i++)r[i]=arguments[i+t];switch(t){case 0:return e.call(this,r);case 1:return e.call(this,arguments[0],r);case 2:return e.call(this,arguments[0],arguments[1],r)}var s=Array(t+1);for(i=0;i<t;i++)s[i]=arguments[i];return s[t]=r,e.apply(this,s)}}function Q(e){var t=typeof e;return t==="function"||t==="object"&&!!e}function ss(e){return e===null}function An(e){return e===void 0}function En(e){return e===!0||e===!1||ft.call(e)==="[object Boolean]"}function as(e){return!!(e&&e.nodeType===1)}function w(e){var t="[object "+e+"]";return function(n){return ft.call(n)===t}}const he=w("String"),_n=w("Number"),os=w("Date"),us=w("RegExp"),ls=w("Error"),xn=w("Symbol"),Nn=w("ArrayBuffer");var Mn=w("Function"),cs=hn.document&&hn.document.childNodes;typeof/./!="function"&&typeof Int8Array!="object"&&typeof cs!="function"&&(Mn=function(e){return typeof e=="function"||!1});const y=Mn,bn=w("Object");var Rn=ts&&bn(new DataView(new ArrayBuffer(8))),fe=typeof Map<"u"&&bn(new Map),hs=w("DataView");function fs(e){return e!=null&&y(e.getInt8)&&Nn(e.buffer)}const bt=Rn?fs:hs,J=es||w("Array");function q(e,t){return e!=null&&ji.call(e,t)}var ne=w("Arguments");(function(){ne(arguments)||(ne=function(e){return q(e,"callee")})})();const ge=ne;function gs(e){return!xn(e)&&rs(e)&&!isNaN(parseFloat(e))}function Dn(e){return _n(e)&&ns(e)}function Vn(e){return function(){return e}}function On(e){return function(t){var n=e(t);return typeof n=="number"&&n>=0&&n<=is}}function Bn(e){return function(t){return t?.[e]}}const Rt=Bn("byteLength"),ps=On(Rt);var ds=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;function ms(e){return dn?dn(e)&&!bt(e):ps(e)&&ds.test(ft.call(e))}const Ln=yn?ms:Vn(!1),_=Bn("length");function Is(e){for(var t={},n=e.length,r=0;r<n;++r)t[e[r]]=!0;return{contains:function(i){return t[i]===!0},push:function(i){return t[i]=!0,e.push(i)}}}function Fn(e,t){t=Is(t);var n=mn.length,r=e.constructor,i=y(r)&&r.prototype||ce,s="constructor";for(q(e,s)&&!t.contains(s)&&t.push(s);n--;)s=mn[n],s in e&&e[s]!==i[s]&&!t.contains(s)&&t.push(s)}function v(e){if(!Q(e))return[];if(gn)return gn(e);var t=[];for(var n in e)q(e,n)&&t.push(n);return Sn&&Fn(e,t),t}function vs(e){if(e==null)return!0;var t=_(e);return typeof t=="number"&&(J(e)||he(e)||ge(e))?t===0:_(v(e))===0}function $n(e,t){var n=v(t),r=n.length;if(e==null)return!r;for(var i=Object(e),s=0;s<r;s++){var o=n[s];if(t[o]!==i[o]||!(o in i))return!1}return!0}function d(e){if(e instanceof d)return e;if(!(this instanceof d))return new d(e);this._wrapped=e}d.VERSION=Cn;d.prototype.value=function(){return this._wrapped};d.prototype.valueOf=d.prototype.toJSON=d.prototype.value;d.prototype.toString=function(){return String(this._wrapped)};function In(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,Rt(e))}var vn="[object DataView]";function re(e,t,n,r){if(e===t)return e!==0||1/e===1/t;if(e==null||t==null)return!1;if(e!==e)return t!==t;var i=typeof e;return i!=="function"&&i!=="object"&&typeof t!="object"?!1:Un(e,t,n,r)}function Un(e,t,n,r){e instanceof d&&(e=e._wrapped),t instanceof d&&(t=t._wrapped);var i=ft.call(e);if(i!==ft.call(t))return!1;if(Rn&&i=="[object Object]"&&bt(e)){if(!bt(t))return!1;i=vn}switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:+e==0?1/+e===1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object Symbol]":return fn.valueOf.call(e)===fn.valueOf.call(t);case"[object ArrayBuffer]":case vn:return Un(In(e),In(t),n,r)}var s=i==="[object Array]";if(!s&&Ln(e)){var o=Rt(e);if(o!==Rt(t))return!1;if(e.buffer===t.buffer&&e.byteOffset===t.byteOffset)return!0;s=!0}if(!s){if(typeof e!="object"||typeof t!="object")return!1;var u=e.constructor,f=t.constructor;if(u!==f&&!(y(u)&&u instanceof u&&y(f)&&f instanceof f)&&"constructor"in e&&"constructor"in t)return!1}n=n||[],r=r||[];for(var h=n.length;h--;)if(n[h]===e)return r[h]===t;if(n.push(e),r.push(t),s){if(h=e.length,h!==t.length)return!1;for(;h--;)if(!re(e[h],t[h],n,r))return!1}else{var p=v(e),m;if(h=p.length,v(t).length!==h)return!1;for(;h--;)if(m=p[h],!(q(t,m)&&re(e[m],t[m],n,r)))return!1}return n.pop(),r.pop(),!0}function Ts(e,t){return re(e,t)}function vt(e){if(!Q(e))return[];var t=[];for(var n in e)t.push(n);return Sn&&Fn(e,t),t}function pe(e){var t=_(e);return function(n){if(n==null)return!1;var r=vt(n);if(_(r))return!1;for(var i=0;i<t;i++)if(!y(n[e[i]]))return!1;return e!==Kn||!y(n[de])}}var de="forEach",qn="has",me=["clear","delete"],Gn=["get",qn,"set"],ks=me.concat(de,Gn),Kn=me.concat(Gn),Ps=["add"].concat(me,de,qn);const ws=fe?pe(ks):w("Map"),Cs=fe?pe(Kn):w("WeakMap"),ys=fe?pe(Ps):w("Set"),Ss=w("WeakSet");function it(e){for(var t=v(e),n=t.length,r=Array(n),i=0;i<n;i++)r[i]=e[t[i]];return r}function As(e){for(var t=v(e),n=t.length,r=Array(n),i=0;i<n;i++)r[i]=[t[i],e[t[i]]];return r}function zn(e){for(var t={},n=v(e),r=0,i=n.length;r<i;r++)t[e[n[r]]]=n[r];return t}function ie(e){var t=[];for(var n in e)y(e[n])&&t.push(n);return t.sort()}function Ie(e,t){return function(n){var r=arguments.length;if(t&&(n=Object(n)),r<2||n==null)return n;for(var i=1;i<r;i++)for(var s=arguments[i],o=e(s),u=o.length,f=0;f<u;f++){var h=o[f];(!t||n[h]===void 0)&&(n[h]=s[h])}return n}}const Hn=Ie(vt),Dt=Ie(v),Qn=Ie(vt,!0);function Es(){return function(){}}function Jn(e){if(!Q(e))return{};if(pn)return pn(e);var t=Es();t.prototype=e;var n=new t;return t.prototype=null,n}function _s(e,t){var n=Jn(e);return t&&Dt(n,t),n}function xs(e){return Q(e)?J(e)?e.slice():Hn({},e):e}function Ns(e,t){return t(e),e}function Xn(e){return J(e)?e:[e]}d.toPath=Xn;function Tt(e){return d.toPath(e)}function ve(e,t){for(var n=t.length,r=0;r<n;r++){if(e==null)return;e=e[t[r]]}return n?e:void 0}function Yn(e,t,n){var r=ve(e,Tt(t));return An(r)?n:r}function Ms(e,t){t=Tt(t);for(var n=t.length,r=0;r<n;r++){var i=t[r];if(!q(e,i))return!1;e=e[i]}return!!n}function Te(e){return e}function gt(e){return e=Dt({},e),function(t){return $n(t,e)}}function ke(e){return e=Tt(e),function(t){return ve(t,e)}}function kt(e,t,n){if(t===void 0)return e;switch(n??3){case 1:return function(r){return e.call(t,r)};case 3:return function(r,i,s){return e.call(t,r,i,s)};case 4:return function(r,i,s,o){return e.call(t,r,i,s,o)}}return function(){return e.apply(t,arguments)}}function Zn(e,t,n){return e==null?Te:y(e)?kt(e,t,n):Q(e)&&!J(e)?gt(e):ke(e)}function Pe(e,t){return Zn(e,t,1/0)}d.iteratee=Pe;function x(e,t,n){return d.iteratee!==Pe?d.iteratee(e,t):Zn(e,t,n)}function bs(e,t,n){t=x(t,n);for(var r=v(e),i=r.length,s={},o=0;o<i;o++){var u=r[o];s[u]=t(e[u],u,e)}return s}function Wn(){}function Rs(e){return e==null?Wn:function(t){return Yn(e,t)}}function Ds(e,t,n){var r=Array(Math.max(0,e));t=kt(t,n,1);for(var i=0;i<e;i++)r[i]=t(i);return r}function se(e,t){return t==null&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}const pt=Date.now||function(){return new Date().getTime()};function jn(e){var t=function(s){return e[s]},n="(?:"+v(e).join("|")+")",r=RegExp(n),i=RegExp(n,"g");return function(s){return s=s==null?"":""+s,r.test(s)?s.replace(i,t):s}}const tr={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},Vs=jn(tr),Os=zn(tr),Bs=jn(Os),Ls=d.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var jt=/(.)^/,Fs={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},$s=/\\|'|\r|\n|\u2028|\u2029/g;function Us(e){return"\\"+Fs[e]}var qs=/^\s*(\w|\$)+\s*$/;function Gs(e,t,n){!t&&n&&(t=n),t=Qn({},t,d.templateSettings);var r=RegExp([(t.escape||jt).source,(t.interpolate||jt).source,(t.evaluate||jt).source].join("|")+"|$","g"),i=0,s="__p+='";e.replace(r,function(h,p,m,N,$){return s+=e.slice(i,$).replace($s,Us),i=$+h.length,p?s+=`'+
((__t=(`+p+`))==null?'':_.escape(__t))+
'`:m?s+=`'+
((__t=(`+m+`))==null?'':__t)+
'`:N&&(s+=`';
`+N+`
__p+='`),h}),s+=`';
`;var o=t.variable;if(o){if(!qs.test(o))throw new Error("variable is not a bare identifier: "+o)}else s=`with(obj||{}){
`+s+`}
`,o="obj";s=`var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};
`+s+`return __p;
`;var u;try{u=new Function(o,"_",s)}catch(h){throw h.source=s,h}var f=function(h){return u.call(this,h,d)};return f.source="function("+o+`){
`+s+"}",f}function Ks(e,t,n){t=Tt(t);var r=t.length;if(!r)return y(n)?n.call(e):n;for(var i=0;i<r;i++){var s=e?.[t[i]];s===void 0&&(s=n,i=r),e=y(s)?s.call(e):s}return e}var zs=0;function Hs(e){var t=++zs+"";return e?e+t:t}function Qs(e){var t=d(e);return t._chain=!0,t}function er(e,t,n,r,i){if(!(r instanceof t))return e.apply(n,i);var s=Jn(e.prototype),o=e.apply(s,i);return Q(o)?o:s}var st=E(function(e,t){var n=st.placeholder,r=function(){for(var i=0,s=t.length,o=Array(s),u=0;u<s;u++)o[u]=t[u]===n?arguments[i++]:t[u];for(;i<arguments.length;)o.push(arguments[i++]);return er(e,r,this,this,o)};return r});st.placeholder=d;const nr=E(function(e,t,n){if(!y(e))throw new TypeError("Bind must be called on a function");var r=E(function(i){return er(e,r,t,this,n.concat(i))});return r}),b=On(_);function X(e,t,n,r){if(r=r||[],!t&&t!==0)t=1/0;else if(t<=0)return r.concat(e);for(var i=r.length,s=0,o=_(e);s<o;s++){var u=e[s];if(b(u)&&(J(u)||ge(u)))if(t>1)X(u,t-1,n,r),i=r.length;else for(var f=0,h=u.length;f<h;)r[i++]=u[f++];else n||(r[i++]=u)}return r}const Js=E(function(e,t){t=X(t,!1,!1);var n=t.length;if(n<1)throw new Error("bindAll must be passed function names");for(;n--;){var r=t[n];e[r]=nr(e[r],e)}return e});function Xs(e,t){var n=function(r){var i=n.cache,s=""+(t?t.apply(this,arguments):r);return q(i,s)||(i[s]=e.apply(this,arguments)),i[s]};return n.cache={},n}const rr=E(function(e,t,n){return setTimeout(function(){return e.apply(null,n)},t)}),Ys=st(rr,d,1);function Zs(e,t,n){var r,i,s,o,u=0;n||(n={});var f=function(){u=n.leading===!1?0:pt(),r=null,o=e.apply(i,s),r||(i=s=null)},h=function(){var p=pt();!u&&n.leading===!1&&(u=p);var m=t-(p-u);return i=this,s=arguments,m<=0||m>t?(r&&(clearTimeout(r),r=null),u=p,o=e.apply(i,s),r||(i=s=null)):!r&&n.trailing!==!1&&(r=setTimeout(f,m)),o};return h.cancel=function(){clearTimeout(r),u=0,r=i=s=null},h}function Ws(e,t,n){var r,i,s,o,u,f=function(){var p=pt()-i;t>p?r=setTimeout(f,t-p):(r=null,n||(o=e.apply(u,s)),r||(s=u=null))},h=E(function(p){return u=this,s=p,i=pt(),r||(r=setTimeout(f,t),n&&(o=e.apply(u,s))),o});return h.cancel=function(){clearTimeout(r),r=s=u=null},h}function js(e,t){return st(t,e)}function we(e){return function(){return!e.apply(this,arguments)}}function ta(){var e=arguments,t=e.length-1;return function(){for(var n=t,r=e[t].apply(this,arguments);n--;)r=e[n].call(this,r);return r}}function ea(e,t){return function(){if(--e<1)return t.apply(this,arguments)}}function ir(e,t){var n;return function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=null),n}}const na=st(ir,2);function sr(e,t,n){t=x(t,n);for(var r=v(e),i,s=0,o=r.length;s<o;s++)if(i=r[s],t(e[i],i,e))return i}function ar(e){return function(t,n,r){n=x(n,r);for(var i=_(t),s=e>0?0:i-1;s>=0&&s<i;s+=e)if(n(t[s],s,t))return s;return-1}}const et=ar(1),or=ar(-1);function ur(e,t,n,r){n=x(n,r,1);for(var i=n(t),s=0,o=_(e);s<o;){var u=Math.floor((s+o)/2);n(e[u])<i?s=u+1:o=u}return s}function lr(e,t,n){return function(r,i,s){var o=0,u=_(r);if(typeof s=="number")e>0?o=s>=0?s:Math.max(s+u,o):u=s>=0?Math.min(s+1,u):s+u+1;else if(n&&s&&u)return s=n(r,i),r[s]===i?s:-1;if(i!==i)return s=t(It.call(r,o,u),Dn),s>=0?s+o:-1;for(s=e>0?o:u-1;s>=0&&s<u;s+=e)if(r[s]===i)return s;return-1}}const cr=lr(1,et,ur),ra=lr(-1,or);function Vt(e,t,n){var r=b(e)?et:sr,i=r(e,t,n);if(i!==void 0&&i!==-1)return e[i]}function ia(e,t){return Vt(e,gt(t))}function F(e,t,n){t=kt(t,n);var r,i;if(b(e))for(r=0,i=e.length;r<i;r++)t(e[r],r,e);else{var s=v(e);for(r=0,i=s.length;r<i;r++)t(e[s[r]],s[r],e)}return e}function H(e,t,n){t=x(t,n);for(var r=!b(e)&&v(e),i=(r||e).length,s=Array(i),o=0;o<i;o++){var u=r?r[o]:o;s[o]=t(e[u],u,e)}return s}function hr(e){var t=function(n,r,i,s){var o=!b(n)&&v(n),u=(o||n).length,f=e>0?0:u-1;for(s||(i=n[o?o[f]:f],f+=e);f>=0&&f<u;f+=e){var h=o?o[f]:f;i=r(i,n[h],h,n)}return i};return function(n,r,i,s){var o=arguments.length>=3;return t(n,kt(r,s,4),i,o)}}const te=hr(1),Tn=hr(-1);function nt(e,t,n){var r=[];return t=x(t,n),F(e,function(i,s,o){t(i,s,o)&&r.push(i)}),r}function sa(e,t,n){return nt(e,we(x(t)),n)}function kn(e,t,n){t=x(t,n);for(var r=!b(e)&&v(e),i=(r||e).length,s=0;s<i;s++){var o=r?r[s]:s;if(!t(e[o],o,e))return!1}return!0}function Pn(e,t,n){t=x(t,n);for(var r=!b(e)&&v(e),i=(r||e).length,s=0;s<i;s++){var o=r?r[s]:s;if(t(e[o],o,e))return!0}return!1}function L(e,t,n,r){return b(e)||(e=it(e)),(typeof n!="number"||r)&&(n=0),cr(e,t,n)>=0}const aa=E(function(e,t,n){var r,i;return y(t)?i=t:(t=Tt(t),r=t.slice(0,-1),t=t[t.length-1]),H(e,function(s){var o=i;if(!o){if(r&&r.length&&(s=ve(s,r)),s==null)return;o=s[t]}return o==null?o:o.apply(s,n)})});function Ce(e,t){return H(e,ke(t))}function oa(e,t){return nt(e,gt(t))}function fr(e,t,n){var r=-1/0,i=-1/0,s,o;if(t==null||typeof t=="number"&&typeof e[0]!="object"&&e!=null){e=b(e)?e:it(e);for(var u=0,f=e.length;u<f;u++)s=e[u],s!=null&&s>r&&(r=s)}else t=x(t,n),F(e,function(h,p,m){o=t(h,p,m),(o>i||o===-1/0&&r===-1/0)&&(r=h,i=o)});return r}function ua(e,t,n){var r=1/0,i=1/0,s,o;if(t==null||typeof t=="number"&&typeof e[0]!="object"&&e!=null){e=b(e)?e:it(e);for(var u=0,f=e.length;u<f;u++)s=e[u],s!=null&&s<r&&(r=s)}else t=x(t,n),F(e,function(h,p,m){o=t(h,p,m),(o<i||o===1/0&&r===1/0)&&(r=h,i=o)});return r}var la=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function gr(e){return e?J(e)?It.call(e):he(e)?e.match(la):b(e)?H(e,Te):it(e):[]}function pr(e,t,n){if(t==null||n)return b(e)||(e=it(e)),e[se(e.length-1)];var r=gr(e),i=_(r);t=Math.max(Math.min(t,i),0);for(var s=i-1,o=0;o<t;o++){var u=se(o,s),f=r[o];r[o]=r[u],r[u]=f}return r.slice(0,t)}function ca(e){return pr(e,1/0)}function ha(e,t,n){var r=0;return t=x(t,n),Ce(H(e,function(i,s,o){return{value:i,index:r++,criteria:t(i,s,o)}}).sort(function(i,s){var o=i.criteria,u=s.criteria;if(o!==u){if(o>u||o===void 0)return 1;if(o<u||u===void 0)return-1}return i.index-s.index}),"value")}function Lt(e,t){return function(n,r,i){var s=t?[[],[]]:{};return r=x(r,i),F(n,function(o,u){var f=r(o,u,n);e(s,o,f)}),s}}const fa=Lt(function(e,t,n){q(e,n)?e[n].push(t):e[n]=[t]}),ga=Lt(function(e,t,n){e[n]=t}),pa=Lt(function(e,t,n){q(e,n)?e[n]++:e[n]=1}),da=Lt(function(e,t,n){e[n?0:1].push(t)},!0);function ma(e){return e==null?0:b(e)?e.length:v(e).length}function Ia(e,t,n){return t in n}const dr=E(function(e,t){var n={},r=t[0];if(e==null)return n;y(r)?(t.length>1&&(r=kt(r,t[1])),t=vt(e)):(r=Ia,t=X(t,!1,!1),e=Object(e));for(var i=0,s=t.length;i<s;i++){var o=t[i],u=e[o];r(u,o,e)&&(n[o]=u)}return n}),va=E(function(e,t){var n=t[0],r;return y(n)?(n=we(n),t.length>1&&(r=t[1])):(t=H(X(t,!1,!1),String),n=function(i,s){return!L(t,s)}),dr(e,n,r)});function mr(e,t,n){return It.call(e,0,Math.max(0,e.length-(t==null||n?1:t)))}function ee(e,t,n){return e==null||e.length<1?t==null||n?void 0:[]:t==null||n?e[0]:mr(e,e.length-t)}function Mt(e,t,n){return It.call(e,t==null||n?1:t)}function Ta(e,t,n){return e==null||e.length<1?t==null||n?void 0:[]:t==null||n?e[e.length-1]:Mt(e,Math.max(0,e.length-t))}function ka(e){return nt(e,Boolean)}function Pa(e,t){return X(e,t,!1)}const Ir=E(function(e,t){return t=X(t,!0,!0),nt(e,function(n){return!L(t,n)})}),wa=E(function(e,t){return Ir(e,t)});function ae(e,t,n,r){En(t)||(r=n,n=t,t=!1),n!=null&&(n=x(n,r));for(var i=[],s=[],o=0,u=_(e);o<u;o++){var f=e[o],h=n?n(f,o,e):f;t&&!n?((!o||s!==h)&&i.push(f),s=h):n?L(s,h)||(s.push(h),i.push(f)):L(i,f)||i.push(f)}return i}const Ca=E(function(e){return ae(X(e,!0,!0))});function ya(e){for(var t=[],n=arguments.length,r=0,i=_(e);r<i;r++){var s=e[r];if(!L(t,s)){var o;for(o=1;o<n&&L(arguments[o],s);o++);o===n&&t.push(s)}}return t}function oe(e){for(var t=e&&fr(e,_).length||0,n=Array(t),r=0;r<t;r++)n[r]=Ce(e,r);return n}const Sa=E(oe);function Aa(e,t){for(var n={},r=0,i=_(e);r<i;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n}function Ea(e,t,n){t==null&&(t=e||0,e=0),n||(n=t<e?-1:1);for(var r=Math.max(Math.ceil((t-e)/n),0),i=Array(r),s=0;s<r;s++,e+=n)i[s]=e;return i}function _a(e,t){if(t==null||t<1)return[];for(var n=[],r=0,i=e.length;r<i;)n.push(It.call(e,r,r+=t));return n}function ye(e,t){return e._chain?d(t).chain():t}function vr(e){return F(ie(e),function(t){var n=d[t]=e[t];d.prototype[t]=function(){var r=[this._wrapped];return Wi.apply(r,arguments),ye(this,n.apply(d,r))}}),d}F(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=Bt[e];d.prototype[e]=function(){var n=this._wrapped;return n!=null&&(t.apply(n,arguments),(e==="shift"||e==="splice")&&n.length===0&&delete n[0]),ye(this,n)}});F(["concat","join","slice"],function(e){var t=Bt[e];d.prototype[e]=function(){var n=this._wrapped;return n!=null&&(n=t.apply(n,arguments)),ye(this,n)}});const xa=Object.freeze(Object.defineProperty({__proto__:null,VERSION:Cn,restArguments:E,isObject:Q,isNull:ss,isUndefined:An,isBoolean:En,isElement:as,isString:he,isNumber:_n,isDate:os,isRegExp:us,isError:ls,isSymbol:xn,isArrayBuffer:Nn,isDataView:bt,isArray:J,isFunction:y,isArguments:ge,isFinite:gs,isNaN:Dn,isTypedArray:Ln,isEmpty:vs,isMatch:$n,isEqual:Ts,isMap:ws,isWeakMap:Cs,isSet:ys,isWeakSet:Ss,keys:v,allKeys:vt,values:it,pairs:As,invert:zn,functions:ie,methods:ie,extend:Hn,extendOwn:Dt,assign:Dt,defaults:Qn,create:_s,clone:xs,tap:Ns,get:Yn,has:Ms,mapObject:bs,identity:Te,constant:Vn,noop:Wn,toPath:Xn,property:ke,propertyOf:Rs,matcher:gt,matches:gt,times:Ds,random:se,now:pt,escape:Vs,unescape:Bs,templateSettings:Ls,template:Gs,result:Ks,uniqueId:Hs,chain:Qs,iteratee:Pe,partial:st,bind:nr,bindAll:Js,memoize:Xs,delay:rr,defer:Ys,throttle:Zs,debounce:Ws,wrap:js,negate:we,compose:ta,after:ea,before:ir,once:na,findKey:sr,findIndex:et,findLastIndex:or,sortedIndex:ur,indexOf:cr,lastIndexOf:ra,find:Vt,detect:Vt,findWhere:ia,each:F,forEach:F,map:H,collect:H,reduce:te,foldl:te,inject:te,reduceRight:Tn,foldr:Tn,filter:nt,select:nt,reject:sa,every:kn,all:kn,some:Pn,any:Pn,contains:L,includes:L,include:L,invoke:aa,pluck:Ce,where:oa,max:fr,min:ua,shuffle:ca,sample:pr,sortBy:ha,groupBy:fa,indexBy:ga,countBy:pa,partition:da,toArray:gr,size:ma,pick:dr,omit:va,first:ee,head:ee,take:ee,initial:mr,last:Ta,rest:Mt,tail:Mt,drop:Mt,compact:ka,flatten:Pa,without:wa,uniq:ae,unique:ae,union:Ca,intersection:ya,difference:Ir,unzip:oe,transpose:oe,zip:Sa,object:Aa,range:Ea,chunk:_a,mixin:vr,default:d},Symbol.toStringTag,{value:"Module"}));var k=vr(xa);k._=k;let Ft=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");class Se{instanceIdInternal=Se.generatePluginIdInternal();enabledInternal=!0;paramsResultInternal={};generatedTrackIdsInternal=[];isRollbackable=!1;songCacheInternal;static providerId(){throw new Error("providerId() should be overwritten.")}static pluginId(){throw new Error("pluginId() should be overwritten.")}static providerDisplayName(){throw new Error("providerDisplayName() should be overwritten.")}static pluginDisplayName(){throw new Error("pluginDisplayName() should be overwritten.")}static pluginDescription(){return null}static allowReset(){return!0}async init(){}params(){return{}}songAccess(){return{}}allowManualApplyAdjust(){return!1}async run(t,n,r){}static async create(){const t=new this;return t.resetInternal(),await t.init(),t}get instanceId(){return this.instanceIdInternal}getParam(t,n){return t[n]}hasAllParamsSet(){for(const t of v(this.params())){if(this.params()[t].optional)continue;const n=this.paramsResultInternal[t];if(n==null)return!1;const i=this.params()[t].widget.type;switch(i){case A.Input:case A.Pitch:case A.Slider:case A.TrackSelector:case A.Select:case A.Switch:case A.InputNumber:case A.FileSelector:break;case A.MultiTrackSelector:if(n.length===0)return!1;break;case A.TrackPitchSelector:if(n.track===void 0||n.track===null||n.pitch===void 0||n.pitch===null)return!1;break;case A.InstrumentSelector:if(n.program===void 0||n.program===null||n.isDrum===void 0||n.isDrum===null)return!1;break;case A.None:if(n==null)return!1;break;default:throw new Error(`Param nullness check needs to be implemented for widget type ${i}. Either use default nullness check or define custom logic.`)}}return!0}static id(){return`${this.providerId()}.${this.pluginId()}`}static getPrefixedArtifactId(t){return`${this.id()}.${t}`}setParamsInternal(t){this.paramsResultInternal=t,this.maybeSyncEnabledWithParamsReadiness()}getParamsInternal(){return this.paramsResultInternal}resetParamsInternal(){for(const t of v(this.params())){const n=this.params()[t];this.paramsResultInternal[t]=n.defaultValue}this.maybeSyncEnabledWithParamsReadiness()}resetInternal(){this.resetParamsInternal(),this.allowManualApplyAdjust()&&(this.enabledInternal=!1)}setEnabledInternal(t){this.enabledInternal=t}maybeSyncEnabledWithParamsReadiness(){this.allowManualApplyAdjust()&&!this.hasAllParamsSet()&&this.setEnabledInternal(!1)}static generatePluginIdInternal(){return Ft(10)}}class Na{plugins=[];threwErrorInLastRun=!1;maxNumPluginsToKeep=50;originalSong;cloneSongFnInternal;readApisInternal;addPlugin(t){this.plugins.push(t),this.maintainPluginListSize()}addPluginAt(t,n){this.plugins.splice(n,0,t),this.maintainPluginListSize()}removePlugin(t){this.plugins.splice(this.plugins.indexOf(t),1)}getPlugins(){return this.plugins}resetCache(){for(const t of this.plugins)delete t.songCacheInternal}setOriginalSong(t){this.originalSong=t}hasOriginalSong(){return!!this.originalSong}async run(t=0){if(!this.originalSong)return this.threwErrorInLastRun=!0,null;t=Math.max(0,t),this.threwErrorInLastRun=!1;let n;const r=this.getIndexOfLatestPluginWithCacheBeforeIndex(t);r>=0?n=await this.cloneSong(this.plugins[r].songCacheInternal):n=await this.cloneSong(this.originalSong);for(let i=t;i<this.plugins.length;i+=1)delete this.plugins[i].songCacheInternal;for(let i=0;i<=r;i+=1){const s=this.plugins[i];s.isRollbackable=!0}for(let i=r>=0?r+1:0;i<this.plugins.length;i+=1){const s=this.plugins[i];if(!s.enabledInternal||!s.hasAllParamsSet())return n;n.setPluginContextInternal(s);try{await s.run(n,s.getParamsInternal(),this.readApisInternal),n.clearPluginContextInternal()}catch{this.threwErrorInLastRun=!0,n.clearPluginContextInternal();const u=this.getIndexOfLatestPluginWithCacheBeforeIndex(i);return u>=0?await this.cloneSong(this.plugins[u].songCacheInternal):await this.cloneSong(this.originalSong)}s.songCacheInternal=await this.cloneSong(n),s.isRollbackable=!0}return n}async cloneSong(t){if(!this.cloneSongFnInternal)throw new Error("Pipeline is not provided with a clone song function.");return this.cloneSongFnInternal(t)}reset(){for(const t of this.plugins)t.resetInternal()}clear(){this.plugins.splice(0,this.plugins.length),this.originalSong=void 0}movePluginUp(t){const n=this.getPluginIndexByPluginInstanceId(t.instanceId);n<=0||this.plugins.splice(n-1,0,this.plugins.splice(n,1)[0])}movePluginDown(t){const n=this.getPluginIndexByPluginInstanceId(t.instanceId);n<0||n>=this.plugins.length-1||this.plugins.splice(n,0,this.plugins.splice(n+1,1)[0])}isPluginFunctioning(t){return!!t.songCacheInternal}getPluginIndexByPluginInstanceId(t){return et(this.plugins,n=>n.instanceId===t)}getThrewErrorInLastRun(){return this.threwErrorInLastRun}getLastFunctioningPlugin(){for(let t=this.plugins.length-1;t>=0;t-=1)if(this.isPluginFunctioning(this.plugins[t]))return this.plugins[t];return null}getPluginCache(t){return t.songCacheInternal}setMaxNumPluginsToKeep(t){this.maxNumPluginsToKeep=t,this.maintainPluginListSize()}getIndexOfLatestPluginWithCacheBeforeIndex(t){for(let n=t-1;n>=0;n-=1)if(this.getPluginCache(this.plugins[n]))return n;return-1}maintainPluginListSize(){for(;this.plugins.length>this.maxNumPluginsToKeep&&this.plugins.length>0;)this.plugins.shift()}}var Nt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ma(e,t,n,r,i){for(var s=i+1;r<=i;){var o=r+i>>>1,u=e[o],f=n!==void 0?n(u,t):u-t;f>=0?(s=o,i=o-1):r=o+1}return s}function ba(e,t,n,r,i){for(var s=i+1;r<=i;){var o=r+i>>>1,u=e[o],f=n!==void 0?n(u,t):u-t;f>0?(s=o,i=o-1):r=o+1}return s}function Ra(e,t,n,r,i){for(var s=r-1;r<=i;){var o=r+i>>>1,u=e[o],f=n!==void 0?n(u,t):u-t;f<0?(s=o,r=o+1):i=o-1}return s}function Da(e,t,n,r,i){for(var s=r-1;r<=i;){var o=r+i>>>1,u=e[o],f=n!==void 0?n(u,t):u-t;f<=0?(s=o,r=o+1):i=o-1}return s}function Va(e,t,n,r,i){for(;r<=i;){var s=r+i>>>1,o=e[s],u=n!==void 0?n(o,t):o-t;if(u===0)return s;u<=0?r=s+1:i=s-1}return-1}function lt(e,t,n,r,i,s){return typeof n=="function"?s(e,t,n,r===void 0?0:r|0,i===void 0?e.length-1:i|0):s(e,t,void 0,n===void 0?0:n|0,r===void 0?e.length-1:r|0)}var P={ge:function(e,t,n,r,i){return lt(e,t,n,r,i,Ma)},gt:function(e,t,n,r,i){return lt(e,t,n,r,i,ba)},lt:function(e,t,n,r,i){return lt(e,t,n,r,i,Ra)},le:function(e,t,n,r,i){return lt(e,t,n,r,i,Da)},eq:function(e,t,n,r,i){return lt(e,t,n,r,i,Va)}},ue={exports:{}};(function(e,t){var n=200,r="__lodash_hash_undefined__",i=9007199254740991,s="[object Arguments]",o="[object Array]",u="[object Boolean]",f="[object Date]",h="[object Error]",p="[object Function]",m="[object GeneratorFunction]",N="[object Map]",$="[object Number]",at="[object Object]",Pt="[object Promise]",Ae="[object RegExp]",wt="[object Set]",Ee="[object String]",_e="[object Symbol]",Ut="[object WeakMap]",xe="[object ArrayBuffer]",Ct="[object DataView]",Ne="[object Float32Array]",Me="[object Float64Array]",be="[object Int8Array]",Re="[object Int16Array]",De="[object Int32Array]",Ve="[object Uint8Array]",Oe="[object Uint8ClampedArray]",Be="[object Uint16Array]",Le="[object Uint32Array]",_r=/[\\^$.*+?()[\]{}|]/g,xr=/\w*$/,Nr=/^\[object .+?Constructor\]$/,Mr=/^(?:0|[1-9]\d*)$/,I={};I[s]=I[o]=I[xe]=I[Ct]=I[u]=I[f]=I[Ne]=I[Me]=I[be]=I[Re]=I[De]=I[N]=I[$]=I[at]=I[Ae]=I[wt]=I[Ee]=I[_e]=I[Ve]=I[Oe]=I[Be]=I[Le]=!0,I[h]=I[p]=I[Ut]=!1;var br=typeof Nt=="object"&&Nt&&Nt.Object===Object&&Nt,Rr=typeof self=="object"&&self&&self.Object===Object&&self,V=br||Rr||Function("return this")(),Fe=t&&!t.nodeType&&t,$e=Fe&&!0&&e&&!e.nodeType&&e,Dr=$e&&$e.exports===Fe;function Vr(a,l){return a.set(l[0],l[1]),a}function Or(a,l){return a.add(l),a}function Br(a,l){for(var c=-1,g=a?a.length:0;++c<g&&l(a[c],c,a)!==!1;);return a}function Lr(a,l){for(var c=-1,g=l.length,T=a.length;++c<g;)a[T+c]=l[c];return a}function Ue(a,l,c,g){var T=-1,C=a?a.length:0;for(g&&C&&(c=a[++T]);++T<C;)c=l(c,a[T],T,a);return c}function Fr(a,l){for(var c=-1,g=Array(a);++c<a;)g[c]=l(c);return g}function $r(a,l){return a?.[l]}function qe(a){var l=!1;if(a!=null&&typeof a.toString!="function")try{l=!!(a+"")}catch{}return l}function Ge(a){var l=-1,c=Array(a.size);return a.forEach(function(g,T){c[++l]=[T,g]}),c}function qt(a,l){return function(c){return a(l(c))}}function Ke(a){var l=-1,c=Array(a.size);return a.forEach(function(g){c[++l]=g}),c}var Ur=Array.prototype,qr=Function.prototype,yt=Object.prototype,Gt=V["__core-js_shared__"],ze=function(){var a=/[^.]+$/.exec(Gt&&Gt.keys&&Gt.keys.IE_PROTO||"");return a?"Symbol(src)_1."+a:""}(),He=qr.toString,U=yt.hasOwnProperty,St=yt.toString,Gr=RegExp("^"+He.call(U).replace(_r,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Qe=Dr?V.Buffer:void 0,Je=V.Symbol,Xe=V.Uint8Array,Kr=qt(Object.getPrototypeOf,Object),zr=Object.create,Hr=yt.propertyIsEnumerable,Qr=Ur.splice,Ye=Object.getOwnPropertySymbols,Jr=Qe?Qe.isBuffer:void 0,Xr=qt(Object.keys,Object),Kt=W(V,"DataView"),ot=W(V,"Map"),zt=W(V,"Promise"),Ht=W(V,"Set"),Qt=W(V,"WeakMap"),ut=W(Object,"create"),Yr=z(Kt),Zr=z(ot),Wr=z(zt),jr=z(Ht),ti=z(Qt),Ze=Je?Je.prototype:void 0,We=Ze?Ze.valueOf:void 0;function G(a){var l=-1,c=a?a.length:0;for(this.clear();++l<c;){var g=a[l];this.set(g[0],g[1])}}function ei(){this.__data__=ut?ut(null):{}}function ni(a){return this.has(a)&&delete this.__data__[a]}function ri(a){var l=this.__data__;if(ut){var c=l[a];return c===r?void 0:c}return U.call(l,a)?l[a]:void 0}function ii(a){var l=this.__data__;return ut?l[a]!==void 0:U.call(l,a)}function si(a,l){var c=this.__data__;return c[a]=ut&&l===void 0?r:l,this}G.prototype.clear=ei,G.prototype.delete=ni,G.prototype.get=ri,G.prototype.has=ii,G.prototype.set=si;function O(a){var l=-1,c=a?a.length:0;for(this.clear();++l<c;){var g=a[l];this.set(g[0],g[1])}}function ai(){this.__data__=[]}function oi(a){var l=this.__data__,c=At(l,a);if(c<0)return!1;var g=l.length-1;return c==g?l.pop():Qr.call(l,c,1),!0}function ui(a){var l=this.__data__,c=At(l,a);return c<0?void 0:l[c][1]}function li(a){return At(this.__data__,a)>-1}function ci(a,l){var c=this.__data__,g=At(c,a);return g<0?c.push([a,l]):c[g][1]=l,this}O.prototype.clear=ai,O.prototype.delete=oi,O.prototype.get=ui,O.prototype.has=li,O.prototype.set=ci;function Y(a){var l=-1,c=a?a.length:0;for(this.clear();++l<c;){var g=a[l];this.set(g[0],g[1])}}function hi(){this.__data__={hash:new G,map:new(ot||O),string:new G}}function fi(a){return Et(this,a).delete(a)}function gi(a){return Et(this,a).get(a)}function pi(a){return Et(this,a).has(a)}function di(a,l){return Et(this,a).set(a,l),this}Y.prototype.clear=hi,Y.prototype.delete=fi,Y.prototype.get=gi,Y.prototype.has=pi,Y.prototype.set=di;function Z(a){this.__data__=new O(a)}function mi(){this.__data__=new O}function Ii(a){return this.__data__.delete(a)}function vi(a){return this.__data__.get(a)}function Ti(a){return this.__data__.has(a)}function ki(a,l){var c=this.__data__;if(c instanceof O){var g=c.__data__;if(!ot||g.length<n-1)return g.push([a,l]),this;c=this.__data__=new Y(g)}return c.set(a,l),this}Z.prototype.clear=mi,Z.prototype.delete=Ii,Z.prototype.get=vi,Z.prototype.has=Ti,Z.prototype.set=ki;function Pi(a,l){var c=Yt(a)||zi(a)?Fr(a.length,String):[],g=c.length,T=!!g;for(var C in a)(l||U.call(a,C))&&!(T&&(C=="length"||Ui(C,g)))&&c.push(C);return c}function je(a,l,c){var g=a[l];(!(U.call(a,l)&&rn(g,c))||c===void 0&&!(l in a))&&(a[l]=c)}function At(a,l){for(var c=a.length;c--;)if(rn(a[c][0],l))return c;return-1}function wi(a,l){return a&&tn(l,Zt(l),a)}function Jt(a,l,c,g,T,C,R){var S;if(g&&(S=C?g(a,T,C,R):g(a)),S!==void 0)return S;if(!_t(a))return a;var on=Yt(a);if(on){if(S=Li(a),!l)return Vi(a,S)}else{var j=K(a),un=j==p||j==m;if(Qi(a))return _i(a,l);if(j==at||j==s||un&&!C){if(qe(a))return C?a:{};if(S=Fi(un?{}:a),!l)return Oi(a,wi(S,a))}else{if(!I[j])return C?a:{};S=$i(a,j,Jt,l)}}R||(R=new Z);var ln=R.get(a);if(ln)return ln;if(R.set(a,S),!on)var cn=c?Bi(a):Zt(a);return Br(cn||a,function(Wt,xt){cn&&(xt=Wt,Wt=a[xt]),je(S,xt,Jt(Wt,l,c,g,xt,a,R))}),S}function Ci(a){return _t(a)?zr(a):{}}function yi(a,l,c){var g=l(a);return Yt(a)?g:Lr(g,c(a))}function Si(a){return St.call(a)}function Ai(a){if(!_t(a)||Gi(a))return!1;var l=an(a)||qe(a)?Gr:Nr;return l.test(z(a))}function Ei(a){if(!nn(a))return Xr(a);var l=[];for(var c in Object(a))U.call(a,c)&&c!="constructor"&&l.push(c);return l}function _i(a,l){if(l)return a.slice();var c=new a.constructor(a.length);return a.copy(c),c}function Xt(a){var l=new a.constructor(a.byteLength);return new Xe(l).set(new Xe(a)),l}function xi(a,l){var c=l?Xt(a.buffer):a.buffer;return new a.constructor(c,a.byteOffset,a.byteLength)}function Ni(a,l,c){var g=l?c(Ge(a),!0):Ge(a);return Ue(g,Vr,new a.constructor)}function Mi(a){var l=new a.constructor(a.source,xr.exec(a));return l.lastIndex=a.lastIndex,l}function bi(a,l,c){var g=l?c(Ke(a),!0):Ke(a);return Ue(g,Or,new a.constructor)}function Ri(a){return We?Object(We.call(a)):{}}function Di(a,l){var c=l?Xt(a.buffer):a.buffer;return new a.constructor(c,a.byteOffset,a.length)}function Vi(a,l){var c=-1,g=a.length;for(l||(l=Array(g));++c<g;)l[c]=a[c];return l}function tn(a,l,c,g){c||(c={});for(var T=-1,C=l.length;++T<C;){var R=l[T],S=g?g(c[R],a[R],R,c,a):void 0;je(c,R,S===void 0?a[R]:S)}return c}function Oi(a,l){return tn(a,en(a),l)}function Bi(a){return yi(a,Zt,en)}function Et(a,l){var c=a.__data__;return qi(l)?c[typeof l=="string"?"string":"hash"]:c.map}function W(a,l){var c=$r(a,l);return Ai(c)?c:void 0}var en=Ye?qt(Ye,Object):Yi,K=Si;(Kt&&K(new Kt(new ArrayBuffer(1)))!=Ct||ot&&K(new ot)!=N||zt&&K(zt.resolve())!=Pt||Ht&&K(new Ht)!=wt||Qt&&K(new Qt)!=Ut)&&(K=function(a){var l=St.call(a),c=l==at?a.constructor:void 0,g=c?z(c):void 0;if(g)switch(g){case Yr:return Ct;case Zr:return N;case Wr:return Pt;case jr:return wt;case ti:return Ut}return l});function Li(a){var l=a.length,c=a.constructor(l);return l&&typeof a[0]=="string"&&U.call(a,"index")&&(c.index=a.index,c.input=a.input),c}function Fi(a){return typeof a.constructor=="function"&&!nn(a)?Ci(Kr(a)):{}}function $i(a,l,c,g){var T=a.constructor;switch(l){case xe:return Xt(a);case u:case f:return new T(+a);case Ct:return xi(a,g);case Ne:case Me:case be:case Re:case De:case Ve:case Oe:case Be:case Le:return Di(a,g);case N:return Ni(a,g,c);case $:case Ee:return new T(a);case Ae:return Mi(a);case wt:return bi(a,g,c);case _e:return Ri(a)}}function Ui(a,l){return l=l??i,!!l&&(typeof a=="number"||Mr.test(a))&&a>-1&&a%1==0&&a<l}function qi(a){var l=typeof a;return l=="string"||l=="number"||l=="symbol"||l=="boolean"?a!=="__proto__":a===null}function Gi(a){return!!ze&&ze in a}function nn(a){var l=a&&a.constructor,c=typeof l=="function"&&l.prototype||yt;return a===c}function z(a){if(a!=null){try{return He.call(a)}catch{}try{return a+""}catch{}}return""}function Ki(a){return Jt(a,!0,!0)}function rn(a,l){return a===l||a!==a&&l!==l}function zi(a){return Hi(a)&&U.call(a,"callee")&&(!Hr.call(a,"callee")||St.call(a)==s)}var Yt=Array.isArray;function sn(a){return a!=null&&Ji(a.length)&&!an(a)}function Hi(a){return Xi(a)&&sn(a)}var Qi=Jr||Zi;function an(a){var l=_t(a)?St.call(a):"";return l==p||l==m}function Ji(a){return typeof a=="number"&&a>-1&&a%1==0&&a<=i}function _t(a){var l=typeof a;return!!a&&(l=="object"||l=="function")}function Xi(a){return!!a&&typeof a=="object"}function Zt(a){return sn(a)?Pi(a):Ei(a)}function Yi(){return[]}function Zi(){return!1}e.exports=Ki})(ue,ue.exports);const wn=ue.exports;class le{ticks;bpm;time;constructor({ticks:t,bpm:n,time:r}){this.ticks=t,this.bpm=n,this.time=r}getTicks(){return this.ticks}getBpm(){return this.bpm}setBpmInternal(t){this.bpm=t}getTime(){return this.time}setTimeInternal(t){this.time=t}}class Tr{ticks;numerator;denominator;constructor({ticks:t,numerator:n,denominator:r}){this.ticks=t,this.numerator=n,this.denominator=r}getTicks(){return this.ticks}setTicks(t){this.ticks=t}getNumerator(){return this.numerator}setNumerator(t){this.numerator=t}getDenominator(){return this.denominator}setDenominator(t){this.denominator=t}}function Oa(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=e%12;return t[n]}function Ba(e){const t=Math.floor(e/12)-2;return Oa(e)+t.toString()}const La=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,Fa={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};function $a(e){const t=La.exec(e);if(!t)return-1;const n=t[1],r=t[2];return Fa[n.toLowerCase()]+(parseInt(r,10)+1)*12}function kr(e,t,n,r){return`${e} // ${t} // ${n} // ${r}`}function Pr(e,t,n){return`${e} // ${t} // ${n}`}function Ua(e){const t=dt(e);return Pr(t.manufacturerName,t.pluginFormatName,t.name)}function dt(e){const t=e.split(" // ");if(t.length<4)throw new Error("Invalid audio plugin tuneflow id.");return{name:t[2],manufacturerName:t[0],pluginFormatName:t[1],pluginVersion:t[3]}}function wr(e,t){return e===t}function Cr(e,t){const n=dt(e),r=dt(t);if(k.keys(n).length!==k.keys(r).length)return!1;for(const i of k.keys(n))if(i!=="pluginVersion"&&n[i]!==r[i])return!1;return!0}class qa{tempoInfos=[];currentTempoIndex=0;ticksPerSecondAtTempoTick={};constructor(t,n){for(const r of t)this.tempoInfos.push({ticks:r.getTicks(),time:r.getTime()}),this.ticksPerSecondAtTempoTick[r.getTicks()]=r.getBpm()*n/60}secondsToTick(t){let n=this.tempoInfos[this.currentTempoIndex];for(;this.tempoInfos[this.currentTempoIndex+1]&&this.tempoInfos[this.currentTempoIndex+1].time<=t;)this.currentTempoIndex+=1,n=this.tempoInfos[this.currentTempoIndex];for(;n.time>t&&this.currentTempoIndex>0;)this.currentTempoIndex-=1,n=this.tempoInfos[this.currentTempoIndex];n.time>t&&(n=this.tempoInfos[0]);const r=t-n.time,i=this.ticksPerSecondAtTempoTick[n.ticks];return Math.round(n.ticks+r*i)}tickToSeconds(t){let n=this.tempoInfos[this.currentTempoIndex];for(;this.tempoInfos[this.currentTempoIndex+1]&&this.tempoInfos[this.currentTempoIndex+1].ticks<=t;)this.currentTempoIndex+=1,n=this.tempoInfos[this.currentTempoIndex];for(;n.ticks>t&&this.currentTempoIndex>0;)this.currentTempoIndex-=1,n=this.tempoInfos[this.currentTempoIndex];n.ticks>t&&(n=this.tempoInfos[0]);const r=t-n.ticks,i=this.ticksPerSecondAtTempoTick[n.ticks];return n.time+r/i}}function yr(e){return e>-100?Math.exp((e-6)*(1/20)):0}function Ga(e){return e<=0?-100:20*Math.log10(e)}function Ka(e){return e>0?20*Math.log(e)+6:-100}function za(e){return e>0?Math.pow(10,(20*Math.log(e)+6)*(1/20)):0}function Ha(e){return e>0?Math.exp((20*Math.log10(e)-6)*(1/20)):0}function Qa(e,t,n,r,i){return(e-t)/(n-t)*(i-r)+r}function Ja(e){return 440*Math.pow(2,(e-69)/12)}class $t{name;manufacturerName;pluginFormatName;pluginVersion;isEnabled=!0;localInstanceIdInternal;base64StatesInternal;constructor(t,n,r,i){this.name=t,this.manufacturerName=n,this.pluginFormatName=r,this.pluginVersion=i,this.localInstanceIdInternal=$t.generateAudioPluginInstanceIdInternal()}getTuneflowId(){return kr(this.manufacturerName,this.pluginFormatName,this.name,this.pluginVersion)}clone(t){const n=t.createAudioPlugin(this.getTuneflowId());return n.setIsEnabled(this.isEnabled),n}matchesTfId(t){return wr(t,this.getTuneflowId())}matchesTfIdIgnoreVersion(t){return Cr(t,this.getTuneflowId())}getInstanceId(){return this.localInstanceIdInternal}toJSON(){return{name:this.name,manufacturerName:this.manufacturerName,pluginFormatName:this.pluginFormatName,pluginVersion:this.pluginVersion,isEnabled:this.isEnabled}}setIsEnabled(t){this.isEnabled=t}getIsEnabled(){return this.isEnabled}setBase64States(t){this.base64StatesInternal=t}getBase64States(){return this.base64StatesInternal}static generateAudioPluginInstanceIdInternal(){return Ft(10)}}class B{pitch;velocity;startTick;endTick;idInternal;clipInternal;constructor({pitch:t,velocity:n,startTick:r,endTick:i,id:s,clip:o}){this.pitch=t,this.velocity=n,this.startTick=r,this.endTick=i,this.idInternal=s,this.clipInternal=o}getPitch(){return this.pitch}setPitch(t){if(!B.isValidPitch(t))throw new Error(`Invalid pitch ${t}`);this.pitch=t}getVelocity(){return this.velocity}setVelocity(t){this.velocity=Math.max(Math.min(t,127),0)}getStartTick(){return this.startTick}getEndTick(){return this.endTick}setStartTick(t){this.startTick=t}setEndTick(t){this.endTick=t}equals(t){return this.startTick===t.getStartTick()&&this.endTick===t.getEndTick()&&this.pitch===t.getPitch()&&this.velocity===t.getVelocity()}deleteFromParent(){!this.clipInternal||this.clipInternal.deleteNote(this)}moveNote(t){if(t===0)return;const n=this.clipInternal;n&&n.deleteNote(this),this.startTick=Math.max(0,this.startTick+t),this.endTick=this.endTick+t,!!this.isRangeValid()&&n&&n.orderedInsertNote(n.getRawNotes(),this)}adjustLeft(t){if(t===0)return;const n=this.clipInternal;n&&n.deleteNote(this),this.startTick+=t,!!this.isRangeValid()&&n&&n.orderedInsertNote(n.getRawNotes(),this)}adjustLeftTo(t){this.adjustLeft(t-this.startTick)}adjustRight(t){this.endTick+=t,this.isRangeValid()||this.deleteFromParent()}adjustRightTo(t){this.adjustRight(t-this.endTick)}isRangeValid(){return B.isNoteRangeValid(this.startTick,this.endTick)}static isValidPitch(t){return t>=0&&t<=127&&Number.isInteger(t)}static isNoteRangeValid(t,n){return n>=0&&t<=n&&Number.isInteger(t)&&Number.isInteger(n)}static isNoteVelocityValid(t){return t>=0&&t<=127&&Number.isInteger(t)}getClip(){return this.clipInternal}adjustPitch(t){this.pitch=this.pitch+t,B.isValidPitch(this.pitch)||this.deleteFromParent()}getId(){return this.idInternal}}var tt=(e=>(e[e.MIDI_CLIP=1]="MIDI_CLIP",e[e.AUDIO_CLIP=2]="AUDIO_CLIP",e))(tt||{});class M{song;track;id;notes;clipStartTick=0;clipEndTick=0;nextNoteIdInternal=1;type;audioClipData;constructor({song:t,type:n,clipStartTick:r,id:i=M.generateClipIdInternal(),track:s=void 0,clipEndTick:o=void 0,audioClipData:u=void 0}){if(this.song=t,this.track=s,this.id=i,this.type=n,this.notes=[],n===2){if(!u)throw new Error("Audio clip data must be provided for audio clips.");this.audioClipData={audioFilePath:u.audioFilePath,startTick:u.startTick,duration:u.duration},r=k.isNumber(r)?Math.max(r,u.startTick):u.startTick;const f=this.getAudioEndTick();(!k.isNumber(o)||f<o)&&(o=f),this.clipStartTick=r,this.clipEndTick=o}else if(n===1){if(this.clipStartTick=r,!k.isNumber(o))throw new Error("clip end tick must be provided when creating MIDI clip.");this.clipEndTick=o}}getId(){return this.id}getType(){return this.type}getAudioClipData(){return this.audioClipData}setAudioFile(t,n,r){this.audioClipData?(this.audioClipData.audioFilePath=t,this.audioClipData.startTick=n,this.audioClipData.duration=r):this.audioClipData={audioFilePath:t,startTick:n,duration:r}}getNotes(){return M.getNotesInRange(this.notes,this.clipStartTick,this.clipEndTick)}getRawNotes(){return this.notes}getDuration(){return this.song.tickToSeconds(this.clipEndTick)-this.song.tickToSeconds(this.clipStartTick)}getAudioDuration(){if(!(this.type!==2||!this.audioClipData))return this.audioClipData.duration}getClipStartTick(){return this.clipStartTick}getClipEndTick(){return this.clipEndTick}getTrack(){return this.track}createNote({pitch:t,velocity:n,startTick:r,endTick:i,updateClipRange:s=!0,resolveClipConflict:o=!0}){if(this.type!==1||!B.isValidPitch(t)||!B.isNoteRangeValid(r,i)||!B.isNoteVelocityValid(n))return null;const u=new B({pitch:t,velocity:n,startTick:r,endTick:i,id:this.getNextNoteIdInternal()});return r<this.clipStartTick&&s&&this.adjustClipLeft(r,o),i>this.clipEndTick&&s&&this.adjustClipRight(i,o),this.orderedInsertNote(this.notes,u),u}getNoteIndexInternal(t){const n=P.lt(this.notes,t,(r,i)=>r.getStartTick()-i.getStartTick());for(let r=Math.max(0,n);r<this.notes.length;r+=1){const i=this.notes[r];if(i&&i===t)return r;if(i&&i.getStartTick()>t.getStartTick())break}return-1}deleteNote(t){const n=this.getNoteIndexInternal(t);n>=0&&this.deleteNoteAt(n)}deleteNoteAt(t){const n=this.notes[t];n&&(n.clipInternal=null,this.notes.splice(t,1))}orderedInsertNote(t,n){if(this.type!==1||n.getClip()===this)return;const r=P.ge(t,n,(i,s)=>i.getStartTick()-s.getStartTick());r<0?t.push(n):t.splice(r,0,n),n.clipInternal=this}adjustClipLeft(t,n=!0){t=Math.max(0,t),this.type===2&&this.audioClipData&&(t=Math.max(t,this.audioClipData.startTick)),t>this.clipEndTick?this.deleteFromParent(!0):(n&&this.track&&this.track.resolveClipConflictInternal(this.getId(),Math.min(this.clipStartTick,t),this.clipEndTick),this.clipStartTick=t)}adjustClipRight(t,n=!0){if(this.type===2){const r=this.getAudioEndTick();k.isNumber(r)&&(t=Math.min(t,r))}t<this.clipStartTick||t<0?this.deleteFromParent(!0):(n&&this.track&&this.track.resolveClipConflictInternal(this.getId(),this.clipStartTick,Math.max(this.clipEndTick,t)),this.clipEndTick=t)}moveClip(t,n){const r=Math.max(0,this.clipStartTick+t),i=this.clipEndTick+t;if(i<0){this.deleteFromParent(!0);return}if(this.track&&this.track.resolveClipConflictInternal(this.getId(),r,i),this.track){const u=this.track.getClipIndex(this);this.track.deleteClipAt(u,!1)}const s=this.clipStartTick,o=this.clipEndTick;if(this.type===1){this.clipStartTick=r,this.clipEndTick=i;for(const u of this.notes)u.setStartTick(u.getStartTick()+t),u.setEndTick(u.getEndTick()+t)}else if(this.type===2){if(!this.audioClipData)throw new Error("Cannot move audio clip without audio data");const u=this.song,f=u.tickToSeconds(this.audioClipData.startTick),h=u.tickToSeconds(s),m=u.tickToSeconds(o)-h,N=h-f,$=u.tickToSeconds(this.clipStartTick+t),at=$-N,Pt=$+m;if(this.clipStartTick=r,this.clipEndTick=u.secondsToTick(Pt),this.audioClipData.startTick=u.secondsToTick(at),this.clipEndTick<0){this.deleteFromParent(!0);return}}this.track&&(this.track.orderedInsertClipInternal(this),n&&this.track.getAutomation().moveAllPointsWithinRange(s,o,t,0))}moveClipTo(t,n){const r=t-this.getClipStartTick();this.moveClip(r,n)}deleteFromParent(t){this.track&&(this.track.deleteClip(this,t),this.track=void 0)}getNotesByIds(t){const n=new Set(t),r=[];for(const i of this.notes)n.has(i.getId())&&r.push(i);return r}getAudioEndTick(){if(this.type!==2||!this.audioClipData)return;const t=this.getAudioDuration();if(!k.isNumber(t))return;const n=this.song.tickToSeconds(this.audioClipData.startTick);return this.song.secondsToTick(n+t)}static getNotesInRange(t,n,r){return M.getNotesInRangeImpl(t,n,r,i=>({getStartTick:()=>i}),i=>i.getStartTick(),i=>i.getEndTick())}static getNotesInRangeImpl(t,n,r,i,s,o){let u=Math.max(0,P.lt(t,i(n),(h,p)=>s(h)-s(p)));for(;t[u]&&!M.isNoteInClip(s(t[u]),o(t[u]),n,r);)u+=1;if(u>=t.length)return[];let f=Math.min(t.length-1,P.gt(t,i(r),(h,p)=>s(h)-s(p)));for(;t[f]&&!M.isNoteInClip(s(t[f]),o(t[f]),n,r);)f-=1;return f<0?[]:f<u?[]:t.slice(u,f+1)}static isNoteInClip(t,n,r,i){return(t>=r||r===0&&t<=0)&&t<=i&&n>=t}static getNotePlayableRange(t,n,r,i){if(!M.isNoteInClip(t,n,r,i))return null;const s=Math.max(t,r),o=Math.min(n,i);return s>o?null:{startTick:s,endTick:o}}trimConflictPartInternal(t,n){const r=Math.max(t,this.getClipStartTick()),i=Math.min(n,this.getClipEndTick());if(!(r>i)&&!(r>this.getClipEndTick()||i<this.getClipStartTick())){if(i>=this.getClipEndTick()&&r<=this.getClipStartTick()){this.deleteFromParent(!0);return}if(i<this.getClipEndTick()&&r>this.getClipStartTick()){const s=i+1,o=this.getClipEndTick();if(this.adjustClipRight(r-1,!1),this.track){if(this.type===1){const u=this.track.createMIDIClip({clipStartTick:s,clipEndTick:o}),f=M.getNotesInRange(this.notes,s,o);for(const h of f)u.createNote({pitch:h.getPitch(),velocity:h.getVelocity(),startTick:h.getStartTick(),endTick:h.getEndTick(),updateClipRange:!1,resolveClipConflict:!1})}else if(this.type===2){const u=this.audioClipData;this.track.createAudioClip({clipStartTick:s,clipEndTick:o,audioClipData:{audioFilePath:u.audioFilePath,startTick:u.startTick,duration:u.duration}})}}return}r>this.getClipStartTick()&&r<=this.getClipEndTick()?this.adjustClipRight(r-1,!1):i<this.getClipEndTick()&&i>=this.getClipStartTick()&&this.adjustClipLeft(i+1,!1)}}getNextNoteIdInternal(){const t=this.nextNoteIdInternal;return this.nextNoteIdInternal>=2147483647?this.nextNoteIdInternal=1:this.nextNoteIdInternal+=1,t}static generateClipIdInternal(){return Ft(10)}}var Sr=(e=>(e[e.UNDEFINED=0]="UNDEFINED",e[e.VOLUME=1]="VOLUME",e[e.PAN=2]="PAN",e[e.AUDIO_PLUGIN=3]="AUDIO_PLUGIN",e))(Sr||{});class D{type;pluginInstanceId;paramId;constructor(t,n,r){this.type=t,this.pluginInstanceId=n,this.paramId=r}getType(){return this.type}setType(t){this.type=t}getPluginInstanceId(){return this.pluginInstanceId}setPluginInstanceId(t){this.pluginInstanceId=t}getParamId(){return this.paramId}setParamId(t){this.paramId=t}equals(t){return D.areAutomationTargetsEqual(this.getType(),t.getType(),this.getPluginInstanceId(),t.getPluginInstanceId(),this.getParamId(),t.getParamId())}clone(){return new D(this.type,this.pluginInstanceId,this.paramId)}toTfAutomationTargetId(){return D.encodeAutomationTarget(this.type,this.pluginInstanceId,this.paramId)}static fromTfAutomationTargetId(t){return D.decodeAutomationTarget(t)}static encodeAutomationTarget(t,n,r){return t===3?`${t}^^${n}^^${r}`:`${t}`}static decodeAutomationTarget(t){const n=t.split("^^");if(n.length===0)throw new Error(`Invalid automation target id: ${t}`);const r=Number(n[0]);return n.length>2?new D(r,n[1],n[2]):new D(r)}static areAutomationTargetsEqual(t,n,r,i,s,o){return D.encodeAutomationTarget(t,r,s)===D.encodeAutomationTarget(n,i,o)}}class rt{points=[];disabled=!1;nextPointIdInternal=1;getDisabled(){return this.disabled}setDisabled(t){this.disabled=t}getPoints(){return this.points}getPointsInRange(t,n){return rt.getPointsInRangeImpl(this.points,t,n)}static getPointsInRangeImpl(t,n,r){const i=P.ge(t,{tick:n},(o,u)=>o.tick-u.tick),s=[];for(let o=i;o<t.length;o+=1){const u=t[o];if(u.tick>r)break;s.push(u)}return s}addPoint(t,n,r=!1){const i={tick:t,value:Math.max(0,Math.min(1,n)),id:this.getNextPointIdInternal()};return rt.orderedInsertPointInternal(this.points,i,r),i}removePoints(t){const n=new Set(t);for(let r=this.points.length-1;r>=0;r-=1){const i=this.points[r];n.has(i.id)&&this.points.splice(r,1)}}removePointsInRange(t,n){const r=P.ge(this.points,{tick:t},(s,o)=>s.tick-o.tick);if(r>=this.points.length)return;let i=r;for(;i+1<this.points.length&&this.points[i+1].tick<=n;)i+=1;this.points.splice(r,i-r+1)}movePointsInRange(t,n,r,i,s=!0){const o=this.getPointsInRange(t,n);this.movePoints(o.map(u=>u.id),r,i,s)}movePoints(t,n,r,i=!0){if(t.length===0)return;const s=new Set(t);let o,u;const f=[];for(let h=0;h<this.points.length;h+=1){const p=this.points[h];!s.has(p.id)||(f.push(p),o===void 0&&(o=h),u=h)}if(!(o===void 0||u===void 0)){if(i){if(n<0){const h=Math.max(0,this.points[o].tick+n),p=P.gt(this.points,{tick:h},(m,N)=>m.tick-N.tick);p<o&&this.points.splice(p,o-p)}else if(n>0){const h=this.points[u].tick+n,p=P.lt(this.points,{tick:h},(m,N)=>m.tick-N.tick);p>u&&this.points.splice(u+1,p-u)}}for(const h of f)h.tick=Math.max(0,h.tick+n),h.value=Math.max(0,Math.min(1,h.value+r));Math.abs(n)>0&&this.points.sort((h,p)=>h.tick-p.tick)}}getNextPointIdInternal(){const t=this.nextPointIdInternal;return this.nextPointIdInternal>=2147483647?this.nextPointIdInternal=1:this.nextPointIdInternal+=1,t}static orderedInsertPointInternal(t,n,r=!1){const i=P.ge(t,n,(s,o)=>s.tick-o.tick);for(;r&&t[i]&&t[i].tick===n.tick;)t.splice(i,1);t.splice(i,0,n)}}class Ar{targets=[];targetValues={};getAutomationTargets(){return this.targets}getAutomationTargetValues(){return this.targetValues}getOrCreateAutomationValueById(t){return this.targetValues[t]||(this.targetValues[t]=new rt),this.targetValues[t]}getAutomationValueById(t){return this.targetValues[t]}getAutomationValueByTarget(t){const n=t.toTfAutomationTargetId();return this.getAutomationValueById(n)}addAutomation(t,n=0){k.isNumber(n)||(n=0),this.targets.splice(n,0,t);const r=t.toTfAutomationTargetId();this.getAutomationValueById(r)||(this.targetValues[r]=new rt)}removeAutomation(t){for(let r=this.targets.length-1;r>=0;r-=1)this.targets[r].equals(t)&&this.targets.splice(r,1);const n=t.toTfAutomationTargetId();delete this.targetValues[n]}removeAutomationOfPlugin(t){for(let n=this.targets.length-1;n>=0;n-=1){const r=this.targets[n];r.getPluginInstanceId()===t&&this.removeAutomation(r)}for(const n of k.keys(this.targetValues)){const r=D.decodeAutomationTarget(n);r.getPluginInstanceId()===t&&this.removeAutomation(r)}}removeAllPointsWithinRange(t,n){for(const r of k.keys(this.targetValues))this.targetValues[r].removePointsInRange(t,n)}moveAllPointsWithinRange(t,n,r,i){for(const s of k.keys(this.targetValues))this.targetValues[s].movePointsInRange(t,n,r,i,!1)}}var Ot=(e=>(e[e.MIDI_TRACK=1]="MIDI_TRACK",e[e.AUDIO_TRACK=2]="AUDIO_TRACK",e))(Ot||{});class mt{insturment;clips;suggestedInstruments;uuid;volume;solo;muted;rank;pan;samplerPlugin;audioPlugins=[];song;automation;type;constructor({type:t,song:n,uuid:r=mt.generateTrackIdInternal(),clips:i=[],instrument:s,suggestedInstruments:o=[],volume:u=yr(0),solo:f=!1,muted:h=!1,rank:p=0,pan:m=0}){this.song=n,this.type=t,s?this.insturment=s:t===1&&(this.insturment=new ct({program:0,isDrum:!1})),this.clips=[...i],this.suggestedInstruments=[...o],this.uuid=r,this.volume=u,this.solo=f,this.muted=h,this.rank=p,this.pan=m,this.automation=new Ar}getType(){return this.type}getSong(){return this.song}getInstrument(){return this.insturment}setInstrument({program:t,isDrum:n}){this.type===1&&(this.insturment=new ct({program:t,isDrum:n}))}getSuggestedInstruments(){return this.suggestedInstruments}createSuggestedInstrument({program:t,isDrum:n}){if(this.type!==1)return;const r=new ct({program:t,isDrum:n});return this.suggestedInstruments.push(r),r}clearSuggestedInstruments(){this.suggestedInstruments=[]}getId(){return this.uuid}setId(t){this.uuid=t}getVolume(){return this.volume}setVolume(t){this.volume=t}setPan(t){this.pan=t}getPan(){return this.pan}getSolo(){return this.solo}setSolo(t){this.solo=t,t&&this.muted&&(this.muted=!1)}getMuted(){return this.muted}setMuted(t){this.muted=t}getRank(){return this.rank}createAudioPlugin(t){const n=dt(t);return new $t(n.name,n.manufacturerName,n.pluginFormatName,n.pluginVersion)}getSamplerPlugin(){return this.samplerPlugin}setSamplerPlugin(t,n=!0){if(this.type!==1)return;const r=!this.samplerPlugin&&!!t||!t&&!!this.samplerPlugin||!!t&&!!this.samplerPlugin&&!t.matchesTfId(this.samplerPlugin.getTuneflowId()),i=this.samplerPlugin;this.samplerPlugin=t,r&&i&&n&&this.automation.removeAutomationOfPlugin(i.getInstanceId())}getAudioPlugins(){return this.audioPlugins}addAudioPlugin(t){this.audioPlugins.push(t)}getTrackStartTick(){return!this.clips||this.clips.length===0?0:this.clips[0].getClipStartTick()}getTrackEndTick(){return!this.clips||this.clips.length===0?0:this.clips[this.clips.length-1].getClipEndTick()}getClipById(t){for(const n of this.clips)if(n.getId()===t)return n;return null}getClips(){return this.clips}getClipsOverlappingWith(t,n){const r=[],i=P.lt(this.clips,{getClipStartTick:()=>t},(s,o)=>s.getClipStartTick()-o.getClipStartTick());for(let s=Math.max(i,0);s<this.clips.length;s+=1){const o=this.clips[s];if(!(o.getClipEndTick()<t)){if(o.getClipStartTick()>n)break;r.push(o)}}return r}createMIDIClip({clipStartTick:t,clipEndTick:n=void 0,insertClip:r=!0}){if(!k.isNumber(t))throw new Error("clipStartTick must be specified when creating a clip.");const i=n??t+1;if(i<t)throw new Error(`clipEndTick must be greater or equal to clipStartTick, got clipStartTick: ${t}, clipEndTick: ${n}`);const s=new M({id:M.generateClipIdInternal(),type:tt.MIDI_CLIP,song:this.song,track:void 0,clipStartTick:t,clipEndTick:i});return r&&this.insertClip(s),s}createAudioClip({clipStartTick:t,audioClipData:n,clipEndTick:r,insertClip:i=!0}){if(!k.isNumber(t))throw new Error("clipStartTick must be specified when creating a clip.");const s=new M({id:M.generateClipIdInternal(),type:tt.AUDIO_CLIP,song:this.song,track:void 0,clipStartTick:t,clipEndTick:r,audioClipData:n});return i&&this.insertClip(s),s}insertClip(t){if(t.getTrack()!==this)t.getTrack()&&t.deleteFromParent(!1),t.track=this;else return;this.resolveClipConflictInternal(t.getId(),t.getClipStartTick(),t.getClipEndTick()),this.orderedInsertClipInternal(t)}cloneClip(t){if(t.getType()===tt.MIDI_CLIP){const n=this.createMIDIClip({clipStartTick:t.getClipStartTick(),clipEndTick:t.getClipEndTick(),insertClip:!1});for(const r of t.getRawNotes())n.createNote({pitch:r.getPitch(),velocity:r.getVelocity(),startTick:r.getStartTick(),endTick:r.getEndTick(),updateClipRange:!1,resolveClipConflict:!1});return n}else{if(t.getType()===tt.AUDIO_CLIP)return this.createAudioClip({clipStartTick:t.getClipStartTick(),clipEndTick:t.getClipEndTick(),audioClipData:t.getAudioClipData(),insertClip:!1});throw new Error(`Unsupported clip type ${t.getType()}`)}}getClipIndex(t){const n=P.le(this.clips,t,(r,i)=>r.getClipStartTick()-i.getClipStartTick());return this.clips.indexOf(t,n)}deleteClip(t,n){const r=this.getClipIndex(t);this.deleteClipAt(r,n)}deleteClipAt(t,n){if(!(t<0)){if(n){const r=this.clips[t];if(!r)return;this.automation.removeAllPointsWithinRange(r.getClipStartTick(),r.getClipEndTick())}this.clips.splice(t,1)}}deleteFromParent(){this.song.removeTrack(this.getId())}getAutomation(){return this.automation}hasAnyAutomation(){return this.automation.getAutomationTargets().length>0&&!k.isEmpty(this.automation.getAutomationTargetValues())}static generateTrackIdInternal(){return Ft()}resolveClipConflictInternal(t,n,r){const i=this.getClipsOverlappingWith(n,r);for(const s of i)s.getId()!==t&&s.trimConflictPartInternal(n,r)}orderedInsertClipInternal(t){const n=P.ge(this.clips,t,(r,i)=>r.getClipStartTick()-i.getClipStartTick());this.clips.splice(n,0,t)}}class ct{program;isDrum;constructor({program:t,isDrum:n}){this.program=t,this.isDrum=n}getProgram(){return this.program}getIsDrum(){return this.isDrum}clone(){return new ct({program:this.program,isDrum:this.isDrum})}}class ht{tracks;PPQ;tempos;timeSignatures;pluginContext;nextTrackRank=1;constructor(){this.tracks=[],this.PPQ=0,this.tempos=[],this.timeSignatures=[]}getTracks(){return this.tracks}getTrackById(t){return Vt(this.tracks,n=>n.getId()===t)}getTracksByIds(t){if(!this.tracks)return[];const n=new Set(t);return this.tracks.filter(r=>n.has(r.getId()))}getTrackIndex(t){return et(this.tracks,n=>n.getId()===t)}createTrack({type:t,index:n,rank:r}){this.checkAccess("createTrack"),r==null||r===null?r=this.getNextTrackRank():this.nextTrackRank=Math.max(r+1,this.nextTrackRank);const i=new mt({type:t,song:this,uuid:this.getNextTrackId(),rank:r==null||r===null?this.getNextTrackRank():r});return n!=null?this.tracks.splice(n,0,i):this.tracks.push(i),i}cloneTrack(t){let n=this.getTrackIndex(t.getId());n<0&&(n=void 0);const r=this.createTrack({type:t.getType(),index:n});if(r.setVolume(t.getVolume()),r.setPan(t.getPan()),r.setSolo(t.getSolo()),r.setMuted(t.getMuted()),t.getType()===Ot.MIDI_TRACK){const i=t.getInstrument();i&&r.setInstrument({program:i.getProgram(),isDrum:i.getIsDrum()});for(const o of t.getSuggestedInstruments())r.createSuggestedInstrument({program:o.getProgram(),isDrum:o.getIsDrum()});const s=t.getSamplerPlugin();s&&r.setSamplerPlugin(s.clone(r))}else t.getType(),Ot.AUDIO_TRACK;for(const i of t.getAudioPlugins())r.addAudioPlugin(i.clone(r));for(const i of t.getClips()){const s=r.cloneClip(i);r.insertClip(s)}return r}removeTrack(t){this.checkAccess("removeTrack");const n=this.getTrackById(t);return n?(this.tracks.splice(et(this.tracks,r=>r.getId()===t),1),n):null}getResolution(){return this.PPQ}getBeatsPerBar(){return this.getTimeSignatures()[0].getNumerator()}getTicksPerBar(){return this.getBeatsPerBar()*this.getResolution()}setResolution(t){this.PPQ=t}getTempoChanges(){return this.tempos}createTempoChange({ticks:t,bpm:n}){if(this.PPQ<=0)throw new Error("Song resolution must be provided before creating tempo changes.");if(this.tempos.length===0&&t!==0)throw new Error("The first tempo event must be at tick 0");const r=new le({ticks:t,bpm:n,time:this.tickToSeconds(t)}),i=P.ge(this.tempos,r,(s,o)=>s.getTicks()-o.getTicks());return i<0?this.tempos.push(r):this.tempos.splice(i,0,r),this.retimingTempoEvents(),r}overwriteTempoChanges(t){if(t.length===0)throw new Error("Cannot clear all the tempo events.");const n=wn(t);n.sort((i,s)=>i.getTicks()-s.getTicks());const r=n[0];if(r.getTicks()>0)throw new Error("The first tempo event needs to start from tick 0");this.tempos=[new le({ticks:0,time:0,bpm:r.getBpm()})];for(let i=1;i<n.length;i+=1){const s=n[i];this.createTempoChange({ticks:s.getTicks(),bpm:s.getBpm()})}}overwriteTimeSignatures(t){this.timeSignatures=wn(t)}updateTempo(t,n){t.setBpmInternal(n),this.retimingTempoEvents()}getTimeSignatures(){return this.timeSignatures}createTimeSignature({ticks:t,numerator:n,denominator:r}){const i=new Tr({ticks:t,numerator:n,denominator:r}),s=P.ge(this.timeSignatures,i,(o,u)=>o.getTicks()-u.getTicks());return s<0?this.timeSignatures.push(i):this.timeSignatures.splice(s,0,i),i}getLastTick(){let t=0;for(const n of this.tracks)t=Math.max(t,n.getTrackEndTick());return t}getDuration(){return this.tickToSeconds(this.getLastTick())}tickToSeconds(t){return ht.tickToSecondsImpl(t,this.getTempoChanges(),this.getResolution())}static tickToSecondsImpl(t,n,r){if(t===0)return 0;let i=P.lt(n,{getTicks:()=>t},(f,h)=>f.getTicks()-h.getTicks());i==-1&&(i=0);const s=n[i],o=t-s.getTicks(),u=ht.tempoBPMToTicksPerSecond(s.getBpm(),r);return s.getTime()+o/u}secondsToTick(t){if(t===0)return 0;let n=P.lt(this.getTempoChanges(),{getTime:()=>t},(o,u)=>o.getTime()-u.getTime());n==-1&&(n=0);const r=this.getTempoChanges()[n],i=t-r.getTime(),s=ht.tempoBPMToTicksPerSecond(r.getBpm(),this.getResolution());return Math.round(r.getTicks()+i*s)}setPluginContextInternal(t){this.pluginContext={plugin:t,numTracksCreatedByPlugin:0}}clearPluginContextInternal(){this.pluginContext=void 0}getNextTrackId(){const t=this.pluginContext,n=t.plugin.generatedTrackIdsInternal;if(t.numTracksCreatedByPlugin===n.length)n.push(mt.generateTrackIdInternal());else if(t.numTracksCreatedByPlugin>n.length)throw new Error("Plugin generated track ids out of sync.");const r=n[t.numTracksCreatedByPlugin];return t.numTracksCreatedByPlugin+=1,r}getNextTrackRank(){const t=this.nextTrackRank;return this.nextTrackRank+=1,t}checkAccess(t){if(!this.pluginContext)throw new Error("Song needs to be accessed in a plugin context in order to use privileged methods.");if(!this.pluginContext.plugin.songAccess()[t])throw new Error(`Plugin ${this.pluginContext.plugin.constructor.id()} requires access ${t} in order to run.`)}static tempoBPMToTicksPerSecond(t,n){return t*n/60}retimingTempoEvents(){this.tempos.sort((t,n)=>t.getTicks()-n.getTicks());for(const t of this.tempos)t.setTimeInternal(this.tickToSeconds(t.getTicks()))}}var A=(e=>(e[e.Slider=1]="Slider",e[e.Input=2]="Input",e[e.TrackSelector=3]="TrackSelector",e[e.Pitch=4]="Pitch",e[e.TrackPitchSelector=5]="TrackPitchSelector",e[e.InstrumentSelector=6]="InstrumentSelector",e[e.Select=7]="Select",e[e.Switch=8]="Switch",e[e.InputNumber=9]="InputNumber",e[e.MultiTrackSelector=10]="MultiTrackSelector",e[e.None=11]="None",e[e.FileSelector=12]="FileSelector",e))(A||{}),Er=(e=>(e[e.SelectedTrackIds=1]="SelectedTrackIds",e[e.SelectedClipInfos=2]="SelectedClipInfos",e[e.TickAtPlayhead=3]="TickAtPlayhead",e[e.EditingClipInfo=4]="EditingClipInfo",e[e.EditingNoteIds=5]="EditingNoteIds",e))(Er||{});exports.AudioPlugin=$t;exports.AutomationData=Ar;exports.AutomationTarget=D;exports.AutomationTargetType=Sr;exports.AutomationValue=rt;exports.Clip=M;exports.ClipType=tt;exports.InjectSource=Er;exports.Note=B;exports.Song=ht;exports.TempoEvent=le;exports.TickToSecondStepper=qa;exports.TimeSignatureEvent=Tr;exports.Track=mt;exports.TrackType=Ot;exports.TuneflowPipeline=Na;exports.TuneflowPlugin=Se;exports.WidgetType=A;exports.areTuneflowIdsEqual=wr;exports.areTuneflowIdsEqualIgnoreVersion=Cr;exports.dbToVolumeValue=yr;exports.decodeAudioPluginTuneflowId=dt;exports.gainToDb=Ga;exports.gainToVolumeValue=Ha;exports.getAudioPluginTuneflowId=kr;exports.getAudioPluginVersionlessTuneflowId=Pr;exports.midiNumberToPitch=Ba;exports.pitchToHz=Ja;exports.pitchToMidiNumber=$a;exports.remapRange=Qa;exports.toVersionlessTfId=Ua;exports.volumeValueToDb=Ka;exports.volumeValueToGain=za;
